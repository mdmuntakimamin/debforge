#!/usr/bin/env bash
set -Eeuo pipefail

ROOT="$HOME/debforge-aarch64"
VAR="$ROOT/var"
LIB="$VAR/lib/debforge"
STATE="$LIB/state"
CACHE="$VAR/cache/debforge"
RUN="$VAR/run/debforge"
LOCK="$VAR/lock"
LOG="$ROOT/logs/status.log"
BIN="$ROOT/bin"

INSTALLED_DB="$LIB/installed.list"
PROJECT_REG="$LIB/project.db"

ts(){ date +"%Y-%m-%d %H:%M:%S"; }
log(){ printf "[%s][STATUS] %s\n" "$(ts)" "$*" >> "$LOG"; }

hr(){ printf "\n============================================================\n"; }
title(){ printf "\n%s\n" "$1"; }

exists(){ [ -e "$1" ]; }
running_pid(){
  local p="$1"
  [ -f "$p" ] && kill -0 "$(cat "$p")" 2>/dev/null
}

show_locks(){
  title "Locks"
  for f in "$LOCK"/*.lock; do
    [ -e "$f" ] || continue
    printf "• %s : " "$(basename "$f")"
    if lsof "$f" >/dev/null 2>&1; then
      echo "LOCKED"
    else
      echo "STALE"
    fi
  done
}

show_pids(){
  title "Running Processes"
  for f in "$RUN"/*.pid; do
    [ -e "$f" ] || continue
    pid=$(cat "$f")
    printf "• %s : " "$(basename "$f")"
    if kill -0 "$pid" 2>/dev/null; then
      echo "RUNNING (pid $pid)"
    else
      echo "DEAD (stale pid $pid)"
    fi
  done
}

show_states(){
  title "State Files"
  for f in "$STATE"/*.state; do
    [ -e "$f" ] || continue
    echo
    echo ">> $(basename "$f")"
    tail -n 20 "$f"
  done
}

show_installed(){
  title "Installed via DebForge"
  if [ -s "$INSTALLED_DB" ]; then
    column -t "$INSTALLED_DB"
  else
    echo "none"
  fi
}

show_projects(){
  title "Registered Projects"
  if [ -s "$PROJECT_REG" ]; then
    nl -w2 -s'. ' "$PROJECT_REG"
  else
    echo "none"
  fi
}

show_cache(){
  title "Cache Summary"
  for f in "$CACHE"/*.cache; do
    [ -e "$f" ] || continue
    printf "%s : %s bytes\n" "$(basename "$f")" "$(stat -c %s "$f")"
  done
}

show_context(){
  title "Current Directory Context"
  if [ -f ".debforge/project.db" ]; then
    echo "inside DebForge project"
    echo
    cat ".debforge/project.db"
  else
    echo "not a DebForge project"
  fi
}

show_health(){
  title "Health Check"
  local ok=1

  for d in "$VAR" "$LIB" "$STATE" "$RUN" "$LOCK"; do
    [ -d "$d" ] || { echo "missing $d"; ok=0; }
  done

  for c in dpkg dpkg-deb tar rsync; do
    command -v "$c" >/dev/null || { echo "missing tool: $c"; ok=0; }
  done

  if [ "$ok" -eq 1 ]; then
    echo "system healthy"
  else
    echo "issues detected"
  fi
}

usage(){
  cat << USAGE
debforge-status [section]

Sections:
  all        show everything
  locks
  pids
  states
  installed
  projects
  cache
  context
  health
USAGE
  exit 0
}

main(){
  mkdir -p "$(dirname "$LOG")"
  : > "$LOG"
  log "status invoked $*"

  case "${1:-all}" in
    all)
      hr
      show_health
      hr
      show_locks
      hr
      show_pids
      hr
      show_states
      hr
      show_installed
      hr
      show_projects
      hr
      show_cache
      hr
      show_context
      hr
      ;;
    locks) show_locks ;;
    pids) show_pids ;;
    states) show_states ;;
    installed) show_installed ;;
    projects) show_projects ;;
    cache) show_cache ;;
    context) show_context ;;
    health) show_health ;;
    *) usage ;;
  esac
}

main "$@"
